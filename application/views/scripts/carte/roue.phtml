<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>E-monitor - Espace Etudiant</title>
    <script src="../js/d3.js"></script>
    <script src="../js/jquery.min.js" charset="utf-8"></script>
		<script src="../js/jquery.blast.min.js"></script>
    <script src="../js/w2ui.js" charset="utf-8"></script>
    <link rel="stylesheet" href="../css/roue.css">
    <link rel="stylesheet" href="../css/opensans.css">
    <link rel="stylesheet" href="../css/sequences.css"/>
    <link rel="stylesheet" href="../css/w2ui-dark.css" />
    <link rel="stylesheet" href="../font/font-awesome/font-awesome.css" />
  </head>
  <body >
    
  <div class="loader"></div>
    <!-- <div id="layout" style="width: 80%; height: 720px; left:50%;margin-left:50%;"></div> -->
    <div id="layout" style="position: absolute; top: 10px; left: 10px; bottom: 30px; right: 10px;"></div>
    <script >
      
    var user = '<?php echo $this->user;?>';
    $(function () {
        var pstyle = ' color: #000000; border: 1px solid #dfdfdf; padding: 5px; ';
        $('#layout').w2layout({
            name: 'layout',
            panels: [
                { type: 'top', size:140, style: pstyle, content: '<div style="float: left; font-size:40px;">Espace Etudiant '+
                  '<br>Connecté en tant que : '+ user+
                  '</div>'+
                  '<div class="w2ui-buttons" style="float: right;" >'+
                  '<button class="w2ui-btn w2ui-btn-grey" style="font-size:40px;" name="deconnexion" onclick="disconnect()">Déconnexion</button>'+
                  '</div>'},
                { type: 'main',  style: pstyle, content: '<div id="vis" align="center" valign="middle"></div>' },
                { type: 'bottom', style: pstyle, content: '<div class="w2ui-buttons" align="center">'+
            '<button class="w2ui-btn w2ui-btn-green" style="font-size:40px;" name="save" onclick="saveEmotion()">Enregistrer</button>'+
          '</div>' }
            ]
        });
    });

    function saveEmotion(){
      console.log("save emotion;");
      var json = {};
        //old code for D3 wheel
      // for (var key in selectedEmotion) {
      //   json[key] = selectedEmotion[key].data;
      // }
      for(var i = 0; i < selectedEmotion.length; i++)
	    {
        json[selectedEmotion[i].substr(0,selectedEmotion[i].length-1)] = selectedEmotion[i].substr(selectedEmotion[i].length-1);
      }
      var dt ={'emotions' : json};
      saveRepD3(dt);
    }

    function saveRepD3(dt) {
			$.ajax({
		    		url: "saverepd3",
		    		data: dt,
		    		type: 'get',
            dataType: 'json',
            error: function(error){
              try {
                var js = JSON.parse(error.responseText);
              } catch (e) {
                console.log(error.responseText)            		  	
              w2alert("Erreur : "+e+dt);
              }
            },            	
            success: function(result) {
              // var message = "<?php echo $this->message ?>";
              saveResult = result;
              // alert (message);
              alert("Emotions enregistrées :)"+result["message"]);
		        }
			});
    }
    
    function disconnect() {
			window.location.href="../auth/deconnexion";
		}

    function addScript(JSfileName) {
    var js = document.createElement('script');
    js.setAttribute('type', 'text/javascript');
    js.src = JSfileName;
    document.body.appendChild(js);
    }

    setTimeout(function(){
      d3.xml("../svg/carto.svg").mimeType("image/svg+xml").get(function(error, xml) {
  if (error) throw error;
	var importedNode = document.importNode(xml.documentElement, true);
  d3.select("div#vis").attr("id","svg-container")
    
    // .attr("transform", "translate( 0," +(parseInt(document.getElementById("layout_layout_panel_main").style.height,10)-623) / 2 + ")")
	  .each(function() {
	    this.appendChild(importedNode);
	  })
	  // inside of our d3.xml callback, call another function
	  // that styles individual paths inside of our imported svg
	  // styleImportedSVG()
    $('.loader').fadeOut();
});
    // d3.select(chart).style("height", "700px");
    }, 100);
    addScript('../js/carto.js');
    
    
    </script>

  </body>
</html>